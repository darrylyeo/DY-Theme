<link rel="import" href="dy-terms.html">
<link rel="import" href="dy-date.html">

<template id="dy-project-header">
	<style>
		:host {
			display: flex;
			justify-content: center;
			align-items: center;
			flex-wrap: wrap;
			overflow: hidden;
			padding: calc(var(--padding) / 2);
			position: relative;
			z-index: 1;
			flex: 100%;
		}
		:host(.dark) {
			color: rgba(255, 255, 255, 0.8);
			-webkit-font-smoothing: antialiased;
		}

		#background, #background:before, #background * {
			background-size: 0;
			opacity: 0.9;
			overflow: hidden;
			position: absolute;
			width: 100%;
			height: 100%;
			left: 0;
			top: 0;
			z-index: -1;
		}
		#background:before {
			content: '';
			background: center/contain fixed;
			background-image: inherit;
			filter: blur(1rem);
			transform: scale(1.2);
		}

		:host > * {
			align-items: center;
			flex-direction: column;
			flex: 1 40%;
			/*flex: 1 20rem;*/
			width: 100%;
			max-width: max-content;
		}
		:host > div > *:not(#background) {
			margin: calc(var(--padding) / 2);
			justify-content: center;
		}

		#title-wrapper {
			background-image: radial-gradient(rgba(255, 255, 255, 0.25), transparent 75%);
			color: #000;
			mix-blend-mode: overlay;
			text-shadow: 0 0 5rem #fff;
			max-width: 100%;
		}
		:host(.dark) #title-wrapper {
			color: #fff;
			text-shadow: 0 0 5rem #000;
		}
		#title-wrapper h1 {
			font-size: 3em;
			line-height: 1.2;
			text-align: center;
		}

		#horizontal-wrapper {
			display: flex;
			align-items: center;
		}

		.excerpt {
			background-color: rgba(255, 255, 255, 0.2);
			box-shadow: var(--box-shadow-1);
			border-radius: 0.5em;
			font-size: 0.9em;
			font-style: italic;
			line-height: 1.6;
			padding: 0.75em;
			text-align: justify;
			max-width: 35em;
		}
		:host(.dark) .excerpt {
			background-color: rgba(0, 0, 0, 0.4);
		}

		#dates {
			font-family: var(--heading-font);
			font-weight: bold;
			flex-wrap: wrap;
			text-transform: uppercase;

			justify-content: center;
			align-items: baseline;
		}
		#dates > * {
			margin: 0 0.25em;
		}
		#modified-date-wrapper {
			font-size: 0.85em;
		}


		@media (min-width: 45rem) {
			#title-wrapper {
				width: 80%;
			}
			.breakpoint-small {
				display: none;
			}
		}
		@media (max-width: 44.9999rem) {
			.breakpoint-large {
				display: none;
			}
		}
	</style>
	<div>
		<div id="background">
			<canvas></canvas>
		</div>
		<div id="title-wrapper">
			<h1 id="title"></h1>
		</div>
		<div id="dates">
			<dy-date id="project-date"></dy-date>
			<span id="modified-date-wrapper">Updated <dy-date id="modified-date"></dy-date></span>
		</div>
		<blockquote class="excerpt breakpoint-large"></blockquote>
	</div>
	<div>
		<figure id="featured-image">
			<img>
			<figcaption></figcaption>
		</figure>
	</div>
	<div>
		<blockquote class="excerpt breakpoint-small"></blockquote>
		<dy-terms></dy-terms>
	</div>
</template>


<script>
class DYProjectHeader extends DYElement {
	connectedCallback(){
		const root = this.root

		this.initialize()

		window.on('pagerender', () => {
			this.initialize()
		})
	}

	initialize(){
		const root = this.root

		const data = WP.current

		root.updateWithModel({
			'#title': data.title.rendered,
			'#project-date[data-date]': data.meta.projectDate,
			'#modified-date[data-date]': data.date,
			'.link[href]': data.link,
			'.excerpt': data.excerpt.rendered
		})
		//root.find('#title').fitText('7.5em')

		this.toggleClass(data.meta.projectHeaderDarkMode === 'true', 'dark')

		if(data.featuredImage){
			const imageData = data.featuredImage

			root.updateWithModel({
				'img[src]': imageData.source_url,
				'img[alt]': imageData.alt_text,
				'figcaption': imageData.caption || imageData.alt_text,
				'#background[style]': {
					'background-image': `url(${imageData.source_url})`
				}
			})

			$DYPage.$background.animateBlurredImage(imageData.source_url)

			root.find('#featured-image').modalize().on('modalize', function(e){
				const img = this.find('img')
				Object.assign(e.detail.finalStyle, {
					width: img.naturalWidth + 'px',
					maxWidth: img.naturalWidth + 'px',
					height: img.naturalHeight + 'px',
					maxHeight: '80vh',
				})
			})
		}else{
			root.updateWithModel({
				'img[src]': '',
				'img[alt]': '',
				'figcaption': '',
				'#background[style]': ''
			})
		}

		// Initialize terms
		root.find('dy-terms').initialize(data.terms)
	}
}
customElements.define('dy-project-header', DYProjectHeader)
</script>