<link rel="import" href="dy-terms.html">
<link rel="import" href="dy-date.html">

<template id="dy-project">
	<style>
		:host {
			/*--transition-slow: 0.5s ease-in-out;*/

			--perspective-intensity: 16;
			--tilt: -10deg;
			--tilt-neg: calc(var(--tilt) * -1);

			--card-shadow: rgba(0, 0, 0, 0.15) 0 1em 4em;

			--transition-duration: 0.5s;
			--transition-timing-function: ease-in-out;
			--transition: var(--transition-duration) var(--transition-timing-function);

			display: flex;
			flex-direction: column;

			flex: 1 10rem;
			width: 300px;
			max-width: 30vmax;
			height: 30vmax;
			max-height: 100vh;
			margin: auto;

			font-size: 0.8em;

			position: relative;
			justify-content: center;

			transform-style: preserve-3d;
			transition: transform var(--transition);

			backface-visibility: hidden;
			-webkit-font-smoothing: subpixel-antialiased;

			pointer-events: initial;
		}
		:host(.focused) {
			--transition-duration: 0.4s;

			transform:
				scale( var(--perspective-intensity) )
				translateZ(
					calc( var(--perspective) * ( 1 - var(--perspective-intensity) ) )
				);
			z-index: 1;
		}
		:host-context(:not(.has-focused-project)):host(:not(.focused)) {
			cursor: pointer;
		}
		:host-context(.has-focused-project):host(:not(.focused)) {
			/*transform: translateZ(calc(var(--perspective) * (1 - 0.75))) scale(0.75);*/
			transform: scale(0.75);
		}
		:host(.hide) {
			/*transform: rotateX(var(--tilt)) translateY(25%) rotateX(var(--tilt-neg));
			cursor: initial;
			pointer-events: none;
			*/

			flex: 0;
			margin: 0;
			padding: 0;
		}



		:host * {
			/*--transition: var(--transition-duration) var(--transition-timing-function);*/
		}
		:host(:not(.focused)) * {
			pointer-events: none;
		}

		#positioning-wrapper {
			justify-content: center;
			transform-style: preserve-3d;
			height: 100%;

			transition: height var(--transition), transform var(--transition);
		}
		/*:host(.hide) #positioning-wrapper {
			transform: translateZ(calc(var(--perspective) * -10));

			--perspective-intensity: 2;
			transform:
				scale( var(--perspective-intensity) )
				scale(1)
				translateZ(
					calc( var(--perspective) * ( 1 - var(--perspective-intensity) ) )
				);
			transform: translateZ(calc(var(--perspective) * 0.1));
		}*/
		:host(.focused) #positioning-wrapper {
			height: 0;
			/*transform: rotateY(180deg) rotateX(180deg) rotate(180deg);*/
		}

		#inner-wrapper {
			flex-direction: column;

			position: absolute;
			padding: 0.5em;

			width: max-content;
			max-width: 100%;

			transform: scale(1) rotateX(var(--tilt));
			transform-origin: top;
			transform-style: preserve-3d;

			transition: transform var(--transition), max-width var(--transition);
		}
		:host(:hover:not(.focused)) #inner-wrapper {
			transform: rotateX(-2.5deg) translateZ(-0.5rem) translateY(-1rem);
			/*transform: translateZ(0.5rem);*/
			--transition: 0.35s var(--ease-out-back);
		}
		:host(.focused) #inner-wrapper {
			width: var(--dy-project-max-width);
			max-width: 260%;
			max-height: var(--dy-project-max-height);
			transform: translateY(-50%);
		}
		
		:host(.hide) #inner-wrapper > *,
		:host-context(.has-focused-project):host(:not(.focused)) #inner-wrapper > * {
			opacity: 0;
		}
		/*:host(.hide) #inner-wrapper > *,
		:host-context(.has-focused-project):host(:not(.focused)) #inner-wrapper > * {
			opacity: 0.1;
		}
		/* Firefox only */
		/*@-moz-document url-prefix() {
			:host(.hide) #inner-wrapper > *,
			:host-context(.has-focused-project):host(:not(.focused)) #inner-wrapper > * {
				opacity: 0.04;
			}
		}*/

		#title-wrapper {
			justify-content: space-between;
			align-items: center;

			min-height: min-content;
			padding-bottom: 0.5em;

			font-size: 0.8em;
			text-align: left;

			transform: rotateX(var(--tilt-neg));
			transform-origin: bottom;

			transition: transform var(--transition), opacity var(--transition);
		}
		:host(:hover) #title-wrapper {
			transform: none;
		}
		:host(.focused) #title-wrapper {
			font-size: 0.9em;
		}
		#title-wrapper h2 {
			color: rgba(0, 0, 0, 0.85);
			text-shadow: #fff 0 0 0.5em, #fff 0 0 1em;

			line-height: 1.25;

			transition: font-size var(--transition);
		}

		#close {
			background-color: rgba(255, 255, 255, 0.25);
			border-radius: 0.5em;
			box-shadow: var(--card-shadow);

			font-size: 1em;

			display: flex;
			justify-content: center;
			align-items: center;

			margin-left: 1em;
			min-width: 2em;
			min-height: 2em;

			cursor: pointer;

			transition: var(--transition-medium);
		}
		#close:hover {
			background-color: rgba(255, 255, 255, 0.5);
			transform: scale(1.05);
		}
		:host(:not(.focused)) #close {
			font-size: 0;
			opacity: 0;
		}

		.card {
			border-radius: 0.5rem;
			overflow: hidden;
			z-index: 1;

			flex-direction: row;

			transition: box-shadow var(--transition), opacity var(--transition);
		}
		:host(:hover) .card {
			box-shadow: var(--card-shadow);
		}
		:host(.focused) .card {
			box-shadow: var(--card-shadow);
		}

		:host(:not(.focused)) #featured-image {
			-webkit-mask-image: linear-gradient(#fff, #fff 7.5rem, rgba(255, 255, 255, 0.25) 15rem, transparent);
			-moz-mask-image: linear-gradient(#fff, #fff 7.5rem, rgba(255, 255, 255, 0.25) 15rem, transparent);
			mask-image: linear-gradient(#fff, #fff 7.5rem, rgba(255, 255, 255, 0.25) 15rem, transparent);
		}
		#featured-image img {
			min-height: 0;
			max-height: 100vh;

			transition: max-height var(--transition);
		}
		:host(.no-featured-image) #featured-image img {
			min-width: 30vmin;
			height: 40vmin;
		}
		:host(.focused) #featured-image img {
			width: auto;
			max-height: calc(var(--dy-project-max-height) - 1.5rem);
		}
		#featured-image img:before {
			content: attr(alt);

			background-color: #67b7e1;
			color: rgba(255, 255, 255, 0.5);

			font-size: 1.2em;
			font-weight: bold;
			text-align: center;
			text-indent: 0;
			text-transform: uppercase;

			display: flex;
			align-items: center;
			padding: 1em;
			height: 100%;
		}

		#details {
			background-color: rgba(255, 255, 255, 0.5);

			overflow-y: auto;
			position: relative;

			min-width: 0;

			transition: flex var(--transition), min-width var(--transition), opacity var(--transition);
		}
		:host(.focused) #details {
			flex: 2;
			min-width: 15rem;
		}
		:host(:not(.focused)) #details {
			flex: 0;
			opacity: 0;
		}

		#details-inner {
			width: 100%;
			min-height: 100%;
			height: min-content;

			flex-direction: column;
			justify-content: space-between;

			padding: calc(var(--padding-small) - 0.5em);
			position: absolute;
		}
		#details-inner > * {
			margin: 0.5em;
		}

		#dates {
			justify-content: space-between;
			flex-wrap: wrap;
			text-align: center;
		}
		#dates > * {
			flex: 0 auto;
		}

		#terms {
			flex-wrap: wrap;
		}

		@media (max-width: 40rem){
			:host(.focused) #inner-wrapper {
				width: max-content;
				max-width: var(--dy-project-max-width);
			}
			.card {
				display: block;
				overflow-y: auto;
			}
			#details-inner {
				position: static;
				width: 0;
				min-width: 100%;
			}
		}
	</style>
	<div id="positioning-wrapper">
		<div id="inner-wrapper">
			<div id="title-wrapper">
				<a class="link"><h2 id="title"></h2></a>
				<div id="close">âœ–</div>
			</div>
			<div class="card">
				<a id="featured-image" class="link"><img></a>
				<div id="details">
					<div id="details-inner">
						<blockquote id="excerpt"></blockquote>
						<!--<a class="link button read-more">Read More</a>-->
						<div id="dates">
							<dy-date id="project-date"></dy-date>
							<span id="modified-date-wrapper">Updated <dy-date id="modified-date"></dy-date></span>
						</div>
						<dy-terms></dy-terms>
						<div id="terms"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
</template>


<script>
class DYProject extends DYElement {
	set data(data){
		const root = this.root

		this._data = data
		
		root.updateWithModel({
			'#title': data.title.rendered,
			'#project-date[data-date]': data.meta.projectDate,
			'#modified-date[data-date]': data.date,
			'.link[href]': data.link,
			'#excerpt': data.excerpt.rendered
		})
		if(data.featuredImage){
			//this.css('backgroundImage', `url(${data.featuredImage.source_url})`)
			root.updateWithModel({
				'img[src]': data.featuredImage.source_url,
				'img[alt]': data.featuredImage.alt_text
			})
		}else{
			this.addClass('no-featured-image')
			root.updateWithModel({
				'img[alt]': data.title.rendered
			})
		}
		this.attr({
			'data-date': data.meta.projectDate,
			'data-modified-date': data.date,
		})

		// Add terms
		/*const $terms = root.find('#terms')
		for(let taxonomyName in DY.data.taxonomies){
			if(taxonomyName === 'page-category') continue

			const terms = data[DY.mapTaxonomyName(taxonomyName)]
			if(!terms.length) continue
			for(let termID of terms){
				const term = DY.data.terms[termID]

				const $term = $$$('a').attr('rel', 'tag').appendTo($terms)
				$term.innerHTML = term.name
				this.addClass(`${taxonomyName}-${term.slug}`)
			}
		}*/

		for(const termID of data.terms){
			const term = DY.data.terms[termID]
			this.addClass(`${DY.mapTaxonomyName(term.taxonomy)}-${term.slug}`)
		}
		root.find('dy-terms')[0].initialize(data.terms)

		this.on({
			click(e){
				if(!this.hasClass('focused'))
					this.$projects.setFocusedProject(this)
			}
		})
		root.find('#close').on({
			click: e => {
				this.$projects.setFocusedProject()
				e.stopPropagation()
			}
		})
	}

	get data(){
		return this._data
	}

	get $projects(){
		return this.closest('dy-projects') || this.getRootNode().host
	}

	set hide(hide){
		this.toggleClass(hide, 'hide')
	}

	set focused(focused){
		this.toggleClass(focused, 'focused')
	}
}
customElements.define('dy-project', DYProject)
</script>