<link rel="import" href="dy-style.html">

<link rel="import" href="dy-header.html">
<link rel="import" href="dy-project-header.html">
<link rel="import" href="dy-sidebar.html">
<link rel="import" href="dy-background.html">
<link rel="import" href="dy-notifications.html">

<link rel="import" href="dy-figure.html">

<template id="dy-page">
	<style>
		@import './wp-content/themes/DY/assets/main.css';
		@import './wp-content/themes/DY/assets/article.css';
		@import './wp-content/themes/DY/assets/footer.css';

		::slotted(*) {
			flex: 100%;
		}

		#to-top.show ~ dy-notifications {
			padding-bottom: 34px;
		}
	</style>

	<dy-background></dy-background>
	<div id="wrapper">
		<dy-header></dy-header>
		<main>
			<slot>
		</main>
		<footer>
			<p>Website Design and Content Â© 2014-2016 Darryl Yeo. All Rights Reserved.<br>Powered by <a href="https://platformmeister.com">Platform Meister</a>.</p>
		</footer>
	</div>
	<div id="to-top"></div>
	<dy-notifications></dy-notifications>
</template>


<script>
class DYPage extends DYElement {
	connectedCallback(){
		window.$DYPage = this

		// Page Content
		window.on('pagerender', () => {
			const content = this.routeAndRender()
			this.html(content)

			if('Prism' in window){
				Prism.highlightAll()
			}
		})

		window.once('pagerender', () => {
			window.on('pagerender', () => {
				document.body.animateScrollY(0)
				$$('#modal').click()
			})
		})

		const root = this.root

		this.$toTop.on('click', () => {
			document.body.animateScrollY(0)
		})
		window.on('scroll.throttle', e => {
			this.$toTop.classList[window.scrollY >= window.innerHeight * 0.5 ? 'add' : 'remove']('show')
		})
		window.trigger('scroll')

		$$('code:not([class*=lanugage-])').addClass('language-*')
	}

	routeAndRender(){
		const data = WP.current
		const route = WP.route

		const templates = {
			//'archive project': () => `
			'front-page': () => `
				<link rel="import" href="./wp-content/themes/DY/assets/components/dy-projects.html">
				<dy-projects class="alternate-layout"></dy-projects>
			`,
			'term-archive': () => `
				<link rel="import" href="./wp-content/themes/DY/assets/components/dy-projects.html">
				<dy-projects class="alternate-layout" category=${data.term_id}></dy-projects>
			`,
			'archive post': () => `
				<link rel="import" href="./wp-content/themes/DY/assets/components/dy-blog.html">
				<dy-blog></dy-blog>
			`,
			'single project': () => `
				<dy-project-header></dy-project-header>
				<article>
					${data.meta.kaId ? `
						<dy-khan data-id="${data.meta.kaId}">
							${data.featuredImage ? `
								<img slot="thumbnail" src="${data.featuredImage.source_url}">
							` : ''}
						</dy-khan>
					` : ''}
					${data.content.rendered}
					${data.comment_status === 'open' ? `<dy-comments></dy-comments>` : ''}
				</article>
				<dy-sidebar></dy-sidebar>
			`,
			'single post': () => `
				<article>
					<h1>${data.title.rendered}</h1>
					${data.featuredImage ? `
						<img slot="thumbnail" src="${data.featuredImage.source_url}">
					` : ''}
					${data.content.rendered}
					${data.comment_status === 'open' ? `<dy-comments></dy-comments>` : ''}
				</article>
				<dy-sidebar></dy-sidebar>
			`,
			'single page': () => `
				<article>
					<h1>${data.title.rendered}</h1>
					${data.content.rendered}
				</article>
			`,
			'404': () => `
				<article>
					<h2>404. :(</h2>
				</article>
			`,
			'error': () => `
				<article>
					<section>
						<h2>Whoops!</h2>
						<p>There was an error loading this content.</p>
						<pre><code>No such route: ${route}</code></pre>
					</section>
				</article>
			`
		}
		
		return templates[route in templates ? route : alert(route) || 'error']()
	}

	animateMain(onAnimateOut, onAnimateIn){
		const $main = this.$main

		$main
			.addClass('hide')
			.once('transitionend', () => {
				/*$main.animateStyleChange(function(){
					onAnimateOut && onAnimateOut()
					this.removeClass('hide')
				}).once('animateend', () => {
					onAnimateIn && onAnimateIn()
				})*/

				const initialHeight = $main.clientHeight + 'px'

				onAnimateOut && onAnimateOut()
				$main.removeClass('hide')

				const finalHeight = $main.clientHeight + 'px'

				$main.animate({
					height: [initialHeight, finalHeight]
				}, {
					duration: 1000
				})
			}, true)
	}

	get $background(){
		return this.root.find('dy-background')
	}

	get $header(){
		return this.root.find('dy-header')
	}

	get $main(){
		return this.root.find('main')
	}

	get $sidebar(){
		return this.root.find('dy-sidebar')
	}

	get $toTop(){
		return this.root.find('#to-top')
	}

	get $notifications(){
		return this.root.find('#notifications')
	}
}
customElements.define('dy-page', DYPage)
</script>