<link rel="import" href="dy-date.html">

<template id="dy-comments">
	<style>
		#inner-wrapper {
			flex-direction: column;
			margin: -0.5rem;
		}
		#inner-wrapper > *, #inner-wrapper > h2, ::slotted(*) {
			margin: 0.5rem;
		}
		#reaction {
			flex-direction: column;
			/*align-items: center;*/
		}
		dy-comment, dy-comment-reply {
			font-size: 0.9em;
		}
	</style>
	<div id="inner-wrapper">
		<h2><span class="comment-count">Loading</span> <span class="reactions">Reactions</span></h2>
		<!--<div id="reaction">
			<h3>Choose One or More Reactions: </h3>
			<ul>
				<li>Don't like it. Like it. Love it!</li>
				<li>Wow. Mind-blowing! HELP, I need a neurosurgeon!!</li>
				<li>Boring. Helpful.</li>
				<li>Learned something new.</li>
				<li>I have a question...</li>
				<li>I have some feedback...</li>
			</ul>
		</div>-->
		<dy-comment-reply></dy-comment-reply>
		<slot>
	</div>
</template>

<template id="dy-comment">
	<style>
		:host {
			display: flex;
			/*flex-wrap: wrap;*/
			align-items: flex-start;
		}
		div {
			flex-direction: column;
		}
		div > * + *, div > * + p {
			margin-top: 0.5em;
		}

		#inner-wrapper {
			flex: 1;
		}
		blockquote, form {
			background-color: rgba(255, 255, 255, 0.5);
			box-shadow: var(--box-shadow-1);
			border-radius: 0.75em;
			padding: 0.75em 1em;
			position: relative;
			flex-direction: column;
		}
		blockquote:before, form:before {
			content: '';
			border: solid transparent;
			border-width: 0.4em 0.5em;
			border-right-color: rgba(255, 255, 255, 0.5);
			position: absolute;
			right: 100%;
			top: 2em;
		}

		#avatar {
			border-radius: 0.75em;
			flex: 0 auto;
			margin: 0;
			margin-right: 0.75em;
			max-width: 10vw;
			width: 5em;
		/*}
		#avatar:not([src]) {*/
			height: 5em;
		}
		header {
			align-items: center;
			flex: 100%;
			font-size: 0.8em;
		}
		header > * + * {
			margin-left: 0.5em;
		}
		cite {
			font-style: normal;
			margin-right: auto;
		}
		#author {
			font-family: var(--heading-font);
			font-size: 1.5em;
			font-weight: bold;

			text-transform: uppercase;
		}
		#comment-date {
			background: rgba(0, 0, 0, 0.05);
			padding: 0.25em;
			border-radius: 0.25em;
			display: inline-block;
			line-height: 1;
		}

		:host(.by-me) #reply-button,
		:host(:not(.by-me)) #edit-button {
			display: none;
		}


		#content {
			display: block;
			margin-top: 0.25em;
		}

		#replies:not(:empty) {
			font-size: 0.9em;
		}
		#replies > * {
			margin-top: 1em;
		}
	</style>
	<img id="avatar">
	<div id="inner-wrapper">
		<blockquote>
			<header>
				<cite>
					<a id="author" rel="nofollow"></a>
				</cite>
				<a class="link"><dy-date id="comment-date"></dy-date></a>
				<dy-buttons>
					<dy-button id="reply-button" theme="plain">Reply</dy-button>
					<dy-button id="edit-button" theme="plain">Edit</dy-button>
				</dy-button>
			</header>
			<div id="content"></div>
		</blockquote>
		<div id="replies">

		</div>
	</div>
</template>

<template id="dy-comment-reply">
	<style>
		@import './wp-content/themes/DY/assets/forms.css';
		
		:host {
			animation: Reply var(--transition-slow);
		}
		@keyframes Reply {
			from {
				max-height: 0;
				overflow: hidden;
				transform: scale(0.9);
			}
			to {
				max-height: 100vh;
			}
		}

		header > * {
			flex: 1;
		}

		input, input:focus, textarea, textarea:focus {
			background: unset;
			border: unset;
			border-radius: unset;
			box-shadow: unset;
			filter unset;
			margin: unset;
			padding: unset;
			display: inline;
			width: 100%;
		}
		textarea {
			max-width: 100%;
			width: 100%;
			min-height: 10em;
		}

		[name="author_email"] {
			font-family: var(--heading-font);
			font-size: 1.25em;
			text-align: right;

			text-transform: uppercase;
		}

		footer {
			justify-content: space-between;
		}

		#meta {
			font-size: 0.9em;
			flex-direction: row;
			flex-wrap: wrap;
		}
		#meta div {
			flex: 1 10rem;
			padding: 0.5em;
		}
	</style>
	<img id="avatar">
	<div id="inner-wrapper">
		<form action="">
			<div>
				<p><a id="sign-in">Sign in with a social account</a> to skip entering credentials: </p>
			</div>
			<hr>
			<header>
				<cite>
					<input type="text" id="author" placeholder="Your Name (Real names only, please!)" name="author_name" required>
				</cite>
				<input type="email" placeholder="your_email@example.com" name="author_email" required>
			</header>
			<div id="content">
				<textarea name="content" placeholder="Your reaction..." required></textarea>
			</div>
			<footer>
				<p><span class="character-count"></span> Characters</p>
				<button type="submit">Post Reaction</button>
			</footer>
			<hr>
			<div id="meta">
				<div>
					<h3>Guidelines</h3>
					<p>Please use your real name.</p>
					<p>Comments will be manually approved.</p>
					<p>Keep it clean and respectful!</p>
				</div>
				<div>
					<h3>Formatting</h3>
					<p>Express yourself **boldly**, with *emphasis* or with `code`.</p>
					<p>Here is a [link](https://darryl-yeo.com).</p>
					<p>```Code blocks work here, too!```</p>
				</div>
			</div>
		</form>
	</div>
	
	<!--<form>
		<label>
			<input type="text" name="author_name">
			<span>Name</span>
		</label>
		<label>
			<input type="email" name="author_email">
			<span>Email</span>
		</label>
	</form>-->
</template>


<script>
const MIN_COMMENT_LENGTH = 20
const MAX_COMMENT_LENGTH = 1000

class DYComments extends DYElement {
	connectedCallback(){
		const root = this.root
		//window.on('pagerender', () => {
			getJSON(`./wp-json/wp/v2/comments?post=${WP.current.id}&per_page=100`).then(comments => {
				root.updateWithModel({
					'.comment-count': comments.length,
					'.reactions': comments.length === 1 ? 'Reaction' : 'Reactions'
				})

				const $comments = {}
				for(const comment of comments){
					const $comment = $$$('dy-comment').appendTo(this)
					X(this, root, $comment)
					$comment.data = comment
					$comments[comment.id] = $comment
				}
				for(const comment of comments){
					if(comment.parent)
						$comments[comment.parent].$replies.append($comments[comment.id])
				}
			})
		//})
	}
}
customElements.define('dy-comments', DYComments)


class DYComment extends DYElement {
	set data(data){
		const root = this.root
		
		this.dataset.id = data.id

		root.updateWithModel({
			'#content': data.content.rendered,
			'#comment-date[data-date]': data.date,
			'.link[href]': data.link,
			'#author': data.author_name,
			'#author[href]': data.author_url,
			'#avatar[src]': data.author_avatar_urls[96]
		})

		root.find('#reply-button').on('click', () => {
			this.$replies.prependChild(DYCommentReply.$reply)
		})

		WP.getUser.then(user => {
			this.toggleClass(data.author === user.id, 'by-me')
		})
	}

	get $replies(){
		const root = this.root
		return root.find('#replies')
	}
}
customElements.define('dy-comment', DYComment)


class DYCommentReply extends DYComment {
	static get _DY_INHERIT_TEMPLATE(){ return false }

	connectedCallback(){
		const root = this.root
		
		const $parent = this.getRootNode().host

		this.formData = {
			'post': $('dy-comments').dataset.id,
			'parent': $parent instanceof DYComment ? $parent.dataset.id : 0,
			'author_user_agent': navigator.userAgent,
			'author_ip': '???',
		}

		const _this = this

		root.find('form').on('submit', function(e){
			e.preventDefault()
			const formData = new FormData(this)
			for(const key in _this.formData){
				formData.set(key, _this.formData[key])
			}
			X(_this.formData, formData, formData.entries())
			for(const entry of formData.entries()){
				X(entry)
			}
			X(formData.getAll('*'))
			//const xhr = new XMLHttpRequest()
			//xhr.send(new FormData(this))

			e.preventDefault()
		})

		const $submit = root.find('[type=submit]')
		const $textarea = root.find('textarea')

		const update = () => {
			const text = $textarea.value.trim()

			if(text.length >= MIN_COMMENT_LENGTH){
				$submit.disabled = false
				$submit.text(`Post reaction`)
			}else{
				$submit.disabled = true
				$submit.text(`${MIN_COMMENT_LENGTH - text.length} characters to go`)
			}
		}

		$textarea.on('input', update)
	}
}
customElements.define('dy-comment-reply', DYCommentReply)

DYCommentReply.$reply = new DYCommentReply
</script>